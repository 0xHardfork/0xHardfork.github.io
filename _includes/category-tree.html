{% comment %}
动态生成分类的目录树
参数: category - 分类对象
{% endcomment %}

{% assign category_path = include.category.path %}
{% assign all_pages = site.pages | where_exp: "page", "page.path contains category_path" | sort: "path" %}

{% comment %}只显示有title的页面，排除index{% endcomment %}
{% assign valid_pages = "" | split: "" %}
{% for page in all_pages %}
{% if page.title and page.name != 'index.md' %}
{% assign valid_pages = valid_pages | push: page %}
{% endif %}
{% endfor %}

{% if valid_pages.size > 0 %}
<ul class="topic-list">
    {% comment %}构建目录树结构{% endcomment %}
    {% assign processed = "" | split: "" %}

    {% for page in valid_pages %}
    {% assign rel_path = page.path | remove: category_path | remove: "/" %}
    {% assign parts = rel_path | split: "/" %}
    {% assign depth = parts.size %}

    {% comment %}一级页面（直接在分类目录下）{% endcomment %}
    {% if depth == 1 %}
    {% unless processed contains page.path %}
    <li><a href="{{ page.url | relative_url }}">{{ page.title }}</a></li>
    {% assign processed = processed | push: page.path %}
    {% endunless %}
    {% endif %}

    {% comment %}二级页面（在子目录中）{% endcomment %}
    {% if depth == 2 %}
    {% assign parent_dir = parts[0] %}
    {% assign parent_key = category_path | append: "/" | append: parent_dir %}

    {% unless processed contains parent_key %}
    {% comment %}查找父目录的index页面{% endcomment %}
    {% assign parent_index = all_pages | where_exp: "p", "p.path contains parent_dir" | where: "name", "index.md" |
    first %}

    {% if parent_index %}
    <li><a href="{{ parent_index.url | relative_url }}">{{ parent_index.title }}</a>
        {% else %}
    <li>{{ parent_dir | replace: "-", " " | capitalize }}
        {% endif %}

        <ul>
            {% for subpage in valid_pages %}
            {% assign sub_rel_path = subpage.path | remove: category_path | remove: "/" %}
            {% assign sub_parts = sub_rel_path | split: "/" %}
            {% if sub_parts.size == 2 and sub_parts[0] == parent_dir %}
            <li><a href="{{ subpage.url | relative_url }}">{{ subpage.title }}</a></li>
            {% endif %}
            {% endfor %}
        </ul>
    </li>
    {% assign processed = processed | push: parent_key %}
    {% endunless %}
    {% endif %}
    {% endfor %}
</ul>
{% endif %}