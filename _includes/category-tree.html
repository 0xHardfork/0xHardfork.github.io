{% comment %}
Dynamically generate category directory tree with collapsible subdirectories
Params: category - category object
{% endcomment %}

{% assign category_path = include.category.path %}
{% assign all_pages = site.pages | where_exp: "page", "page.path contains category_path" | sort: "path" %}

{% comment %}Only show pages with titles, exclude index{% endcomment %}
{% assign valid_pages = "" | split: "" %}
{% for page in all_pages %}
{% if page.title and page.name != 'index.md' %}
{% assign valid_pages = valid_pages | push: page %}
{% endif %}
{% endfor %}

{% if valid_pages.size > 0 %}
<ul class="topic-list">
    {% comment %}Build directory tree structure{% endcomment %}
    {% assign processed_parents = "" | split: "" %}
    {% assign processed_children = "" | split: "" %}

    {% comment %}First pass - group pages by directory{% endcomment %}
    {% assign subdirs = "" | split: "" %}
    {% for page in valid_pages %}
    {% assign rel_path = page.path | remove_first: category_path | remove_first: "/" %}
    {% assign parts = rel_path | split: "/" %}
    {% if parts.size == 2 %}
    {% assign parent_dir = parts[0] %}
    {% unless subdirs contains parent_dir %}
    {% assign subdirs = subdirs | push: parent_dir %}
    {% endunless %}
    {% endif %}
    {% endfor %}

    {% comment %}Render level 1 pages and collapsible parent directories{% endcomment %}
    {% for page in valid_pages %}
    {% assign rel_path = page.path | remove_first: category_path | remove_first: "/" %}
    {% assign parts = rel_path | split: "/" %}
    {% assign depth = parts.size %}

    {% if depth == 1 %}
    {% comment %}Level 1 pages (directly under category directory){% endcomment %}
    <li><a href="{{ page.url | relative_url }}">{{ page.title }}</a></li>
    {% elsif depth == 2 %}
    {% comment %}Level 2 pages - group under collapsible parent{% endcomment %}
    {% assign parent_dir = parts[0] %}

    {% unless processed_parents contains parent_dir %}
    {% comment %}Find or create parent directory listing{% endcomment %}
    {% assign parent_index = all_pages | where_exp: "p", "p.path contains parent_dir" | where: "name", "index.md" |
    first %}

    <li class="has-children">
        <div class="parent-item">
            <span class="toggle-icon">â–¸</span>
            {% if parent_index %}
            <a href="{{ parent_index.url | relative_url }}" class="parent-link">{{ parent_index.title }}</a>
            {% else %}
            <span class="parent-label">{{ parent_dir | replace: "-", " " | capitalize }}</span>
            {% endif %}
        </div>
        <ul class="nested-list">
            {% comment %}Find all children of this parent{% endcomment %}
            {% for child_page in valid_pages %}
            {% assign child_rel_path = child_page.path | remove_first: category_path | remove_first: "/" %}
            {% assign child_parts = child_rel_path | split: "/" %}
            {% if child_parts.size == 2 and child_parts[0] == parent_dir %}
            <li><a href="{{ child_page.url | relative_url }}">{{ child_page.title }}</a></li>
            {% endif %}
            {% endfor %}
        </ul>
    </li>
    {% assign processed_parents = processed_parents | push: parent_dir %}
    {% endunless %}
    {% endif %}
    {% endfor %}
</ul>
{% endif %}